<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Đơn Hàng - Poly Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .info-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            background-color: #f8f9fa;
        }
        .product-item {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }
        .product-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-receipt"></i> Chi Tiết Đơn Hàng #<span th:text="${order.orderId}">1</span></h2>
            <a th:href="@{/orders}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
        
        <!-- Flash Messages -->
        <div th:if="${message}" th:class="'alert alert-' + ${messageType == 'success' ? 'success' : 'danger'} + ' alert-dismissible fade show'" role="alert">
            <span th:text="${message}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div class="row">
            <!-- Order Information -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Thông Tin Đơn Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Mã đơn hàng:</strong> #<span th:text="${order.orderId}">1</span></p>
                                <p><strong>Ngày đặt:</strong> <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">Date</span></p>
                                <p><strong>Trạng thái:</strong> 
                                    <!-- ✅ FIX: Sử dụng order.statusId thay vì order.status -->
                                    <span th:class="'badge ' + 
                                        ${order.statusId == 1 ? 'bg-warning' : 
                                        (order.statusId == 2 ? 'bg-info' : 
                                        (order.statusId == 3 ? 'bg-primary' : 
                                        (order.statusId == 4 ? 'bg-success' : 'bg-danger')))}" 
                                          th:text="${order.statusId == 1 ? 'Chờ xử lý' : 
                                                   (order.statusId == 2 ? 'Đang xử lý' : 
                                                   (order.statusId == 3 ? 'Đang giao' : 
                                                   (order.statusId == 4 ? 'Đã giao' : 'Đã hủy')))}">
                                        Status
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Số điện thoại:</strong> <span th:text="${order.phone}">Phone</span></p>
                                <p><strong>Địa chỉ giao hàng:</strong><br>
                                    <span th:text="${order.shippingAddress}">Address</span>
                                </p>
                            </div>
                        </div>
                        
                        <div th:if="${order.note != null && !#strings.isEmpty(order.note)}">
                            <p><strong>Ghi chú:</strong> <span th:text="${order.note}">Note</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Sản Phẩm</h5>
                    </div>
                    <div class="card-body">
                        <div class="product-item" th:each="detail : ${orderDetails}">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    <img th:src="${detail.product.imageUrl}" 
                                         th:alt="${detail.product.name}"
                                         class="img-fluid rounded"
                                         style="max-height: 80px; object-fit: cover;">
                                </div>
                                <div class="col-md-5">
                                    <h6 class="mb-1" th:text="${detail.product.name}">Product name</h6>
                                    <!-- ✅ FIX: Sử dụng detail.unitPrice thay vì detail.price -->
                                    <small class="text-muted">Đơn giá: <span th:text="${#numbers.formatDecimal(detail.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Price</span></small>
                                </div>
                                <div class="col-md-2 text-center">
                                    <p class="mb-0">x<span th:text="${detail.quantity}">1</span></p>
                                </div>
                                <div class="col-md-3 text-end">
                                    <!-- ✅ FIX: Sử dụng detail.unitPrice * quantity -->
                                    <h6 class="text-primary mb-0" th:text="${#numbers.formatDecimal(detail.unitPrice * detail.quantity, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Total</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator"></i> Tổng Đơn Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính:</span>
                            <strong th:text="${#numbers.formatDecimal(order.total, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí vận chuyển:</span>
                            <strong>Miễn phí</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <h5>Tổng cộng:</h5>
                            <h5 class="text-success" th:text="${#numbers.formatDecimal(order.total, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</h5>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs"></i> Thao Tác</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a th:href="@{/orders/{id}/track(id=${order.orderId})}" class="btn btn-primary">
                                <i class="fas fa-truck"></i> Theo dõi đơn hàng
                            </a>
                            
                            <!-- ✅ FIX: Chỉ hiển thị nút hủy khi statusId = 1 (Pending) -->
                            <form th:if="${order.statusId == 1}" 
                                  th:action="@{/orders/{id}/cancel(id=${order.orderId})}" 
                                  method="post"
                                  onsubmit="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này?');">
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="fas fa-times-circle"></i> Hủy đơn hàng
                                </button>
                            </form>
                            
                            <a href="mailto:support@polyshop.com" class="btn btn-outline-secondary">
                                <i class="fas fa-envelope"></i> Liên hệ hỗ trợ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>